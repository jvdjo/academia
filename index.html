<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia Pro - Planejador de Treinos Inteligente</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .view { display: none; }
        .view.active { display: block; }
        .loader {
            border: 4px solid #374151; /* gray-700 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-content-view { display: none; }
        .modal-content-view.active { display: block; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex-col items-center justify-center hidden">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-white">Carregando...</p>
    </div>

    <!-- Login View -->
    <div id="login-view" class="view active">
        <div class="min-h-screen flex items-center justify-center bg-gray-900 px-4">
            <div class="w-full max-w-md bg-gray-800 p-8 rounded-2xl shadow-2xl border border-gray-700">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-white">Academia Pro</h1>
                    <p id="form-title" class="text-gray-400 mt-2">Seu planejador de treinos baseado em ci√™ncia.</p>
                </div>

                <div id="error-message" class="bg-red-500/20 border border-red-500 text-red-300 px-4 py-3 rounded-lg mb-6 text-center hidden">
                    <p id="error-text"></p>
                </div>

                <form id="auth-form" class="space-y-6">
                    <div>
                        <label for="email" class="text-sm font-medium text-gray-300">Email</label>
                        <input type="email" id="email" placeholder="seu@email.com" required class="mt-1 w-full p-3 bg-gray-700 rounded-md text-white border border-gray-600 focus:border-blue-500 focus:ring-blue-500 transition">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-300">Senha</label>
                        <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required class="mt-1 w-full p-3 bg-gray-700 rounded-md text-white border border-gray-600 focus:border-blue-500 focus:ring-blue-500 transition">
                    </div>
                    <div>
                        <button type="submit" id="auth-btn" class="w-full p-3 bg-blue-600 rounded-md text-white font-semibold hover:bg-blue-700 transition-transform transform hover:scale-105">
                            Entrar
                        </button>
                    </div>
                </form>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-600"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-800 text-gray-400">ou</span></div>
                </div>

                <div>
                    <button id="google-login-btn" class="w-full flex items-center justify-center p-3 bg-white rounded-md text-gray-800 font-semibold hover:bg-gray-200 transition">
                        <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.089,5.571l6.19,5.238C41.38,36.168,44,31.134,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                        Entrar com Google
                    </button>
                </div>

                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-400">
                        <span id="toggle-text">N√£o tem uma conta?</span>
                        <button id="toggle-form-btn" class="font-semibold text-blue-400 hover:text-blue-300">Cadastre-se</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="view">
        <header class="bg-gray-800/80 backdrop-blur-sm sticky top-0 z-30 shadow-lg border-b border-gray-700">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <h1 class="text-2xl font-bold text-white">Academia Pro</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-email-display" class="hidden sm:block text-gray-300"></span>
                        <button id="logout-btn" class="p-2 bg-red-600 rounded-md text-white font-semibold hover:bg-red-700 transition">Sair</button>
                    </div>
                </div>
            </div>
        </header>
        <main class="container mx-auto p-4 sm:p-6 lg:p-8 min-h-screen">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-white mb-3">Meu Plano Semanal</h2>
                <p class="text-gray-400 text-lg">Baseado no Guia Mestre de Hipertrofia - Planeje seus treinos por por√ß√£o muscular</p>
            </div>
            <div id="weekly-planner" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-7 gap-6 mb-12"></div>
            
            <!-- Informa√ß√µes do Guia -->
            <div class="bg-gray-800/50 rounded-xl p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4">üìö Sobre o Guia Mestre de Hipertrofia</h3>
                <div class="grid md:grid-cols-3 gap-6 text-sm">
                    <div>
                        <h4 class="font-semibold text-blue-400 mb-2">üéØ √änfase Regional</h4>
                        <p class="text-gray-400">Direcione o est√≠mulo para por√ß√µes espec√≠ficas atrav√©s da manipula√ß√£o do vetor de for√ßa, trajet√≥ria e posi√ß√£o de m√°xima tens√£o.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-blue-400 mb-2">üî¨ Base Cient√≠fica</h4>
                        <p class="text-gray-400">Mais de 100 refer√™ncias cient√≠ficas fundamentam cada recomenda√ß√£o de exerc√≠cio e t√©cnica apresentada.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-blue-400 mb-2">üí™ Desenvolvimento Completo</h4>
                        <p class="text-gray-400">Cobertura completa de todos os grupos musculares com exerc√≠cios compostos e de isolamento.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Workout Modal -->
    <div id="workout-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col border border-gray-700">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center flex-shrink-0">
                <h2 id="modal-title" class="text-2xl font-bold text-white">Montar Treino</h2>
                <button class="close-modal-btn text-gray-400 hover:text-white transition text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-body" class="p-6 flex-grow overflow-y-auto custom-scrollbar">
                <!-- Views will be injected here -->
            </div>
            <div class="p-5 border-t border-gray-700 flex-shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-grow">
                        <h4 class="text-sm font-semibold text-white mb-2">üìã Resumo do Treino</h4>
                        <div id="workout-summary" class="text-sm text-gray-400">
                            <span id="exercise-count">0 exerc√≠cios selecionados</span>
                            <div id="muscle-groups" class="mt-1"></div>
                        </div>
                    </div>
                    <p id="save-status" class="text-green-400 text-sm hidden">‚úÖ Salvo com sucesso!</p>
                </div>
                <div class="flex justify-end items-center space-x-4">
                    <button id="cancel-workout-btn" class="px-6 py-2 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-500 transition">Cancelar</button>
                    <button id="save-workout-btn" class="px-6 py-2 bg-blue-600 rounded-lg text-white font-semibold hover:bg-blue-700 transition flex items-center">
                        <span class="mr-2">üíæ</span> Salvar Treino
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // setLogLevel('debug');

        // --- Data baseada no Guia Mestre de Hipertrofia ---
        const exerciseData = {
            'Peitoral': { 
                'Superior (Clavicular)': [
                    'Supino Inclinado com Halteres',
                    'Crossover com Polia Baixa (Crucifixo Inclinado)',
                    'Supino Inclinado na M√°quina Smith',
                    'Supino Inclinado Articulado'
                ], 
                'Medial (Esternocostal)': [
                    'Supino Reto com Barra',
                    'Crucifixo com Halteres (Fly Reto)',
                    'Flex√£o de Bra√ßos (Push-up)',
                    'Supino com Halteres no Banco Reto'
                ], 
                'Inferior (Abdominal)': [
                    'Mergulho nas Paralelas (Dips)',
                    'Supino Declinado com Barra',
                    'Supino Declinado com Halteres',
                    'Crossover com Polia Alta'
                ] 
            },
            'Ombros': { 
                'Anterior (Frontal)': [
                    'Desenvolvimento com Halteres',
                    'Eleva√ß√£o Frontal com Halteres',
                    'Eleva√ß√£o Frontal na Polia',
                    'Desenvolvimento Arnold (Arnold Press)'
                ], 
                'Lateral (Medial)': [
                    'Eleva√ß√£o Lateral com Halteres',
                    'Eleva√ß√£o Lateral na Polia',
                    'Remada Alta com Pegada Aberta',
                    'Desenvolvimento com Pegada Aberta'
                ], 
                'Posterior (Traseira)': [
                    'Crucifixo Inverso com Halteres',
                    'Crucifixo Inverso na M√°quina (Pec-Deck Invertida)',
                    'Face Pull',
                    'Remada com Pegada Aberta e Pronada'
                ] 
            },
            'Costas': { 
                'Largura (Lat√≠ssimo)': [
                    'Barra Fixa com Pegada Aberta',
                    'Puxada Frontal na Polia (Lat Pulldown)',
                    'Remada Unilateral com Halter (Serrote)',
                    'Pullover com Halter'
                ], 
                'Espessura (Trap√©zio/Romboides)': [
                    'Remada Curvada com Barra',
                    'Remada Cavalinho (T-Bar Row)',
                    'Encolhimento com Barra (Shrugs)',
                    'Encolhimento com Halteres',
                    'Remada na Polia Baixa'
                ], 
                'Lombar (Eretores)': [
                    'Levantamento Terra (Deadlift)',
                    'Hiperextens√£o Lombar',
                    'Superman',
                    'Good Morning'
                ] 
            },
            'Bra√ßos': { 
                'B√≠ceps': [
                    'Rosca Direta com Barra',
                    'Rosca Inclinada com Halteres',
                    'Rosca Martelo',
                    'Rosca Concentrada',
                    'Rosca na Polia Baixa'
                ], 
                'Tr√≠ceps': [
                    'Supino com Pegada Fechada',
                    'Tr√≠ceps Testa (Skull Crusher)',
                    'Tr√≠ceps na Polia Alta (Pushdown)',
                    'Tr√≠ceps Franc√™s',
                    'Mergulho entre Bancos'
                ], 
                'Antebra√ßos': [
                    'Rosca de Punho',
                    'Rosca de Punho Invertida',
                    'Caminhada do Fazendeiro (Farmer\'s Walk)',
                    'Rosca de Punho na Polia'
                ] 
            },
            'Pernas': { 
                'Quadr√≠ceps': [
                    'Agachamento Livre com Barra',
                    'Leg Press 45¬∞',
                    'Cadeira Extensora',
                    'Agachamento Frontal',
                    'Agachamento no Smith'
                ], 
                'Isquiotibiais': [
                    'Levantamento Terra Romeno (RDL)',
                    'Stiff com Halteres',
                    'Mesa Flexora',
                    'Cadeira Flexora',
                    'Eleva√ß√£o P√©lvica (Glute Bridge)'
                ], 
                'Gl√∫teos': [
                    'Eleva√ß√£o de Quadril com Barra (Hip Thrust)',
                    'Agachamento B√∫lgaro',
                    'Cadeira Abdutora',
                    'Agachamento Sumo',
                    'Passada (Afundo)'
                ], 
                'Panturrilhas': [
                    'Eleva√ß√£o de Panturrilha em P√©',
                    'Eleva√ß√£o de Panturrilha Sentado',
                    'Panturrilha no Leg Press',
                    'Pular Corda'
                ] 
            },
            'Core': { 
                'Reto Abdominal': [
                    'Abdominal na Polia Alta (Cable Crunch)',
                    'Eleva√ß√£o de Pernas em Suspens√£o',
                    'Abdominal Reto (Crunch)',
                    'Eleva√ß√£o de Pernas no Solo'
                ], 
                'Obl√≠quos': [
                    'Prancha Lateral',
                    'Rota√ß√£o de Tronco na Polia (Woodchopper)',
                    'Giro Russo (Russian Twist)',
                    'Abdominal Obl√≠quo'
                ], 
                'Estabilizadores': [
                    'Prancha Frontal (Plank)',
                    'Perdigueiro (Bird-Dog)',
                    'Press Pallof',
                    'Prancha com Movimentos'
                ] 
            }
        };
        const daysOfWeek = [ { key: 'monday', name: 'Segunda' }, { key: 'tuesday', name: 'Ter√ßa' }, { key: 'wednesday', name: 'Quarta' }, { key: 'thursday', name: 'Quinta' }, { key: 'friday', name: 'Sexta' }, { key: 'saturday', name: 'S√°bado' }, { key: 'sunday', name: 'Domingo' } ];
        
        // --- State ---
        let isLoginMode = true, currentEditingDay = null, currentUserId = null, unsubscribePlan = null;
        let weeklyPlanData = {}, tempWorkoutList = [];

        // --- DOM Elements ---
        const [loginView, appView, loadingOverlay, authForm, authBtn, googleLoginBtn, toggleFormBtn, formTitle, toggleText, errorMessageDiv, errorText, logoutBtn, userEmailSpan, weeklyPlanner, modal, modalTitle, modalBody, saveWorkoutBtn, cancelWorkoutBtn, saveStatus] = ['login-view', 'app-view', 'loading-overlay', 'auth-form', 'auth-btn', 'google-login-btn', 'toggle-form-btn', 'form-title', 'toggle-text', 'error-message', 'error-text', 'logout-btn', 'user-email-display', 'weekly-planner', 'workout-modal', 'modal-title', 'modal-body', 'save-workout-btn', 'cancel-workout-btn', 'save-status'].map(id => document.getElementById(id));
        
        // --- UI Functions ---
        const showLoading = show => loadingOverlay.classList.toggle('hidden', !show);
        const showError = msg => { errorText.textContent = msg; errorMessageDiv.classList.remove('hidden'); };
        const hideError = () => errorMessageDiv.classList.add('hidden');
        
        const toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            authForm.reset();
            hideError();
            formTitle.textContent = isLoginMode ? 'Seu planejador de treinos baseado em ci√™ncia.' : 'Crie sua conta e comece a treinar.';
            authBtn.textContent = isLoginMode ? 'Entrar' : 'Cadastrar';
            toggleText.textContent = isLoginMode ? 'N√£o tem uma conta?' : 'J√° tem uma conta?';
            toggleFormBtn.textContent = isLoginMode ? 'Cadastre-se' : 'Entrar';
        };

        const renderWeeklyPlanner = () => {
            weeklyPlanner.innerHTML = daysOfWeek.map(day => {
                const dayPlan = weeklyPlanData[day.key] || { muscles: [], exercises: [] };
                const hasWorkout = dayPlan.exercises.length > 0;
                const muscleText = dayPlan.muscles.length > 0 ? dayPlan.muscles.join(', ') : 'Descanso';
                const exerciseCount = dayPlan.exercises.length;
                
                return `
                <div class="bg-gray-800 rounded-xl shadow-lg p-5 flex flex-col border-2 ${hasWorkout ? 'border-blue-500/50 bg-gradient-to-br from-gray-800 to-gray-900' : 'border-gray-700'} hover:border-blue-400/70 transition-all duration-300">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-xl text-white">${day.name}</h3>
                        ${hasWorkout ? '<div class="w-3 h-3 bg-green-500 rounded-full"></div>' : '<div class="w-3 h-3 bg-gray-500 rounded-full"></div>'}
                    </div>
                    
                    <div class="flex-grow min-h-[100px] mb-4">
                        <p class="font-semibold text-base ${hasWorkout ? 'text-blue-400' : 'text-gray-500'} mb-2">${muscleText}</p>
                        ${hasWorkout ? `
                            <div class="space-y-1">
                                <p class="text-gray-400 text-sm">${exerciseCount} exerc√≠cio${exerciseCount !== 1 ? 's' : ''}</p>
                                <div class="max-h-16 overflow-y-auto custom-scrollbar">
                                    ${dayPlan.exercises.slice(0, 3).map(ex => `<p class="text-xs text-gray-500">‚Ä¢ ${ex}</p>`).join('')}
                                    ${dayPlan.exercises.length > 3 ? `<p class="text-xs text-gray-500">... e mais ${dayPlan.exercises.length - 3}</p>` : ''}
                                </div>
                            </div>
                        ` : '<p class="text-gray-500 text-sm">Clique para planejar seu treino</p>'}
                    </div>
                    
                    <button data-day="${day.key}" class="edit-workout-btn w-full p-3 rounded-lg text-sm font-semibold transition-all duration-200 ${hasWorkout ? 'bg-gray-700 hover:bg-gray-600 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'} transform hover:scale-105">
                        ${hasWorkout ? '‚úèÔ∏è Editar Treino' : '‚ûï Montar Treino'}
                    </button>
                </div>`;
            }).join('');
            document.querySelectorAll('.edit-workout-btn').forEach(btn => btn.addEventListener('click', () => openWorkoutModal(btn.dataset.day)));
        };

        const openWorkoutModal = (dayKey) => {
            currentEditingDay = dayKey;
            const dayName = daysOfWeek.find(d => d.key === dayKey).name;
            modalTitle.textContent = `üèãÔ∏è Treino de ${dayName}`;
            tempWorkoutList = [...(weeklyPlanData[currentEditingDay]?.exercises || [])];
            renderModalView('groups');
            modal.classList.remove('hidden');
            // Aguarda o modal aparecer antes de atualizar o resumo
            setTimeout(updateWorkoutSummary, 100);
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            // Limpa o resumo
            const exerciseCountEl = document.getElementById('exercise-count');
            const muscleGroupsEl = document.getElementById('muscle-groups');
            if (exerciseCountEl) exerciseCountEl.textContent = '0 exerc√≠cios selecionados';
            if (muscleGroupsEl) muscleGroupsEl.innerHTML = '';
        };

        const renderModalView = (viewName, context = {}) => {
            let html = '';
            switch(viewName) {
                case 'groups':
                    html = `
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-semibold mb-3 text-white">üéØ Selecione o Grupo Muscular</h3>
                        <p class="text-gray-400">Escolha qual grupo muscular voc√™ quer treinar hoje</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${Object.keys(exerciseData).map(group => {
                            const icons = {
                                'Peitoral': 'üí™',
                                'Ombros': 'üî•',
                                'Costas': 'üèãÔ∏è',
                                'Bra√ßos': 'üí•',
                                'Pernas': 'ü¶µ',
                                'Core': '‚ö°'
                            };
                            return `
                            <button class="modal-nav-btn group p-6 border-2 border-gray-600 rounded-xl text-center hover:bg-gray-700 hover:border-blue-500 transition-all duration-300 transform hover:scale-105" data-view="portions" data-group="${group}">
                                <div class="text-3xl mb-2">${icons[group] || 'üéØ'}</div>
                                <div class="text-white font-semibold">${group}</div>
                            </button>`;
                        }).join('')}
                    </div>`;
                    break;
                case 'portions':
                    html = `
                    <button class="modal-nav-btn mb-6 flex items-center text-blue-400 hover:text-blue-300 transition" data-view="groups">
                        <span class="mr-2">‚Üê</span> Voltar aos grupos
                    </button>
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-semibold mb-3 text-white">üîç Por√ß√µes de <span class="text-blue-400">${context.group}</span></h3>
                        <p class="text-gray-400">Selecione a por√ß√£o espec√≠fica que deseja trabalhar</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${Object.keys(exerciseData[context.group]).map(portion => `
                        <button class="modal-nav-btn p-5 border-2 border-gray-600 rounded-xl text-center hover:bg-gray-700 hover:border-blue-500 transition-all duration-300 transform hover:scale-105" data-view="exercises" data-group="${context.group}" data-portion="${portion}">
                            <div class="text-white font-semibold mb-2">${portion}</div>
                            <div class="text-sm text-gray-400">${exerciseData[context.group][portion].length} exerc√≠cios</div>
                        </button>`).join('')}
                    </div>`;
                    break;
                case 'exercises':
                    const selectedExercises = tempWorkoutList.filter(ex => exerciseData[context.group][context.portion].includes(ex));
                    html = `
                    <button class="modal-nav-btn mb-6 flex items-center text-blue-400 hover:text-blue-300 transition" data-view="portions" data-group="${context.group}">
                        <span class="mr-2">‚Üê</span> Voltar √†s por√ß√µes
                    </button>
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-semibold mb-3 text-white">üí™ Exerc√≠cios para <span class="text-blue-400">${context.portion}</span></h3>
                        <p class="text-gray-400">Selecione os exerc√≠cios que deseja incluir no treino</p>
                        ${selectedExercises.length > 0 ? `<p class="text-green-400 mt-2">‚úÖ ${selectedExercises.length} exerc√≠cio${selectedExercises.length !== 1 ? 's' : ''} selecionado${selectedExercises.length !== 1 ? 's' : ''}</p>` : ''}
                    </div>
                    <div class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                        ${exerciseData[context.group][context.portion].map(ex => `
                        <label class="flex items-center p-4 rounded-lg hover:bg-gray-700/50 cursor-pointer border border-gray-700 hover:border-gray-600 transition-all duration-200">
                            <input type="checkbox" data-exercise="${ex}" class="form-checkbox h-5 w-5 bg-gray-700 border-gray-600 rounded text-blue-600 focus:ring-blue-500 focus:ring-2" ${tempWorkoutList.includes(ex) ? 'checked' : ''}>
                            <span class="ml-4 text-gray-300 flex-grow">${ex}</span>
                            ${tempWorkoutList.includes(ex) ? '<span class="text-green-400 text-sm">‚úì</span>' : ''}
                        </label>`).join('')}
                    </div>
                    <div class="mt-6 p-4 bg-gray-700/50 rounded-lg">
                        <p class="text-sm text-gray-400 mb-2">üí° <strong>Dica:</strong> Baseado no Guia Mestre de Hipertrofia</p>
                        <p class="text-xs text-gray-500">Combine exerc√≠cios compostos (for√ßa) com isolamentos (hipertrofia) para resultados otimizados.</p>
                    </div>`;
                    break;
            }
            modalBody.innerHTML = html;
            modalBody.querySelectorAll('.modal-nav-btn').forEach(btn => btn.addEventListener('click', e => renderModalView(e.currentTarget.dataset.view, e.currentTarget.dataset)));
            modalBody.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', handleExerciseSelection));
            // Atualiza o resumo ap√≥s renderizar
            setTimeout(updateWorkoutSummary, 50);
        };
        
        const handleExerciseSelection = (e) => {
            const { exercise } = e.target.dataset;
            if (e.target.checked) {
                if (!tempWorkoutList.includes(exercise)) tempWorkoutList.push(exercise);
            } else {
                tempWorkoutList = tempWorkoutList.filter(ex => ex !== exercise);
            }
            updateWorkoutSummary();
        };

        const updateWorkoutSummary = () => {
            const exerciseCountEl = document.getElementById('exercise-count');
            const muscleGroupsEl = document.getElementById('muscle-groups');
            
            if (exerciseCountEl) {
                const count = tempWorkoutList.length;
                exerciseCountEl.textContent = `${count} exerc√≠cio${count !== 1 ? 's' : ''} selecionado${count !== 1 ? 's' : ''}`;
            }
            
            if (muscleGroupsEl) {
                const muscleGroups = [...new Set(tempWorkoutList.flatMap(ex => 
                    Object.keys(exerciseData).filter(group => 
                        Object.values(exerciseData[group]).flat().includes(ex)
                    )
                ))];
                
                if (muscleGroups.length > 0) {
                    muscleGroupsEl.innerHTML = `<span class="text-blue-400">Grupos: ${muscleGroups.join(', ')}</span>`;
                } else {
                    muscleGroupsEl.innerHTML = '';
                }
            }
        };

        // --- Firebase Logic ---
        const handleAuthAction = async (e) => {
            e.preventDefault();
            hideError();
            showLoading(true);
            const email = authForm.email.value;
            const password = authForm.password.value;
            try {
                if (isLoginMode) await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) { showError(getFirebaseErrorMessage(error)); } 
            finally { showLoading(false); }
        };

        const handleGoogleLogin = async () => {
            hideError();
            showLoading(true);
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } 
            catch (error) { showError(getFirebaseErrorMessage(error)); } 
            finally { showLoading(false); }
        };

        const handleLogout = async () => {
            showLoading(true);
            await signOut(auth);
            weeklyPlanData = {};
            if (unsubscribePlan) unsubscribePlan();
            showLoading(false);
        };

        const saveWorkoutToFirestore = async () => {
            if (!currentEditingDay || !currentUserId) return;
            showLoading(true);
            const muscleGroups = [...new Set(tempWorkoutList.flatMap(ex => Object.keys(exerciseData).filter(group => Object.values(exerciseData[group]).flat().includes(ex))))];
            const newDayPlan = { muscles: muscleGroups, exercises: tempWorkoutList };
            const planRef = doc(db, `artifacts/${appId}/users/${currentUserId}/plans/weeklyPlan`);
            try {
                await setDoc(planRef, { [currentEditingDay]: newDayPlan }, { merge: true });
                saveStatus.classList.remove('hidden');
                setTimeout(() => saveStatus.classList.add('hidden'), 2000);
                closeModal();
            } catch (error) { console.error("Error saving workout:", error); alert("Erro ao salvar."); }
            finally { showLoading(false); }
        };

        const listenToPlanUpdates = (userId) => {
            if (unsubscribePlan) unsubscribePlan();
            const planRef = doc(db, `artifacts/${appId}/users/${userId}/plans/weeklyPlan`);
            unsubscribePlan = onSnapshot(planRef, (docSnap) => {
                weeklyPlanData = docSnap.exists() ? docSnap.data() : {};
                renderWeeklyPlanner();
            }, (error) => console.error("Firestore listener error:", error));
        };

        const getFirebaseErrorMessage = (error) => ({
            'auth/invalid-email': 'Formato de email inv√°lido.', 'auth/user-not-found': 'Email ou senha incorretos.', 'auth/wrong-password': 'Email ou senha incorretos.', 'auth/email-already-in-use': 'Este email j√° est√° cadastrado.', 'auth/weak-password': 'A senha deve ter pelo menos 6 caracteres.', 'auth/popup-closed-by-user': 'A janela de login foi fechada.'
        }[error.code] || 'Ocorreu um erro. Tente novamente.');

        // --- Auth State & App Init ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                loginView.classList.remove('active');
                appView.classList.add('active');
                userEmailSpan.textContent = user.email || 'Usu√°rio';
                listenToPlanUpdates(user.uid);
            } else {
                currentUserId = null;
                appView.classList.remove('active');
                loginView.classList.add('active');
                if (unsubscribePlan) unsubscribePlan();
            }
        });

        const initializeAppAuth = async () => {
            showLoading(true);
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
            } catch (error) { console.error("Auth token sign-in failed:", error); } 
            finally { showLoading(false); }
        };
        
        // --- Event Listeners ---
        toggleFormBtn.addEventListener('click', toggleAuthMode);
        authForm.addEventListener('submit', handleAuthAction);
        googleLoginBtn.addEventListener('click', handleGoogleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);
        cancelWorkoutBtn.addEventListener('click', closeModal);
        saveWorkoutBtn.addEventListener('click', saveWorkoutToFirestore);

        initializeAppAuth();
        renderWeeklyPlanner();
    </script>
</body>
</html>
